name: Deploy Server to Heroku

on:
    push:
        branches: ["main"]
        paths:
            - "server/**"
            - ".github/workflows/server-deploy.yml"
            - "package.json"

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: "./server/package-lock.json"

            - name: Install dependencies
              run: |
                  npm ci
                  cd server && npm ci

            - name: Install Heroku CLI
              run: |
                  curl https://cli-assets.heroku.com/install.sh | sh
                  heroku --version

            - name: Login to Heroku
              env:
                  HEROKU_EMAIL: ${{ secrets.HEROKU_EMAIL }}
                  HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
              run: |
                  mkdir -p ~/.netrc
                  echo "machine api.heroku.com login $HEROKU_EMAIL password $HEROKU_API_KEY" > ~/.netrc
                  chmod 600 ~/.netrc

            - name: Check Heroku access
              run: |
                  heroku apps:info -a ${{ secrets.HEROKU_APP_NAME }}

            - name: Build and push Docker image
              run: |
                  heroku container:push web -a ${{ secrets.HEROKU_APP_NAME }}

            - name: Release the container
              run: |
                  heroku container:release web -a ${{ secrets.HEROKU_APP_NAME }}
